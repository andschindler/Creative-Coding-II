<!DOCTYPE html>
<html lang="en">
  <head>
    <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-environment-component@1.3.x/dist/aframe-environment-component.min.js"></script>
  </head>

  <body>
    <a-scene>
      <a-assets>
        <a-asset-item
          id="guitar"
          src="https://cdn.glitch.global/dac312c4-5145-47d4-8a18-3684e2763a69/generic_electronic_guitar.glb?v=1750723479382"
        ></a-asset-item>
        <a-asset-item
          id="piano"
          src="https://cdn.glitch.global/dac312c4-5145-47d4-8a18-3684e2763a69/piano.glb?v=1750722921083"
        ></a-asset-item>
        <a-asset-item
          id="drums"
          src="https://cdn.glitch.global/dac312c4-5145-47d4-8a18-3684e2763a69/drums.glb?v=1750725752915"
        ></a-asset-item>

        <!-- Sound assets -->
        <audio id="sound-drums" src="https://cdn.glitch.global/deaad1b3-c137-49a3-b9f1-f506e217d6d8/Michael%20Jackson%20Loop-drums.mp3?v=1750764225146"></audio>
        <audio id="sound-guitar" src="https://cdn.glitch.global/deaad1b3-c137-49a3-b9f1-f506e217d6d8/Michael%20Jackson%20Loop-vocals.mp3?v=1750764228420"></audio>
        <audio id="sound-piano" src="https://cdn.glitch.global/deaad1b3-c137-49a3-b9f1-f506e217d6d8/Michael%20Jackson%20Loop-bass.mp3?v=1750764233292"></audio>
      </a-assets>

      <a-gltf-model
        id="pianoModel"
        src="#piano"
        position="4 0.8 -2"
        scale="0.9 0.9 0.9"
        rotation="0 10 10"
        animation__float="property: object3D.position.y; to: 0.5; dir: alternate; dur: 2000; loop: true"
        class="interactive"
      ></a-gltf-model>

      <a-gltf-model
        id="drumsModel"
        src="#drums"
        position="-2 1.2 -2"
        scale="0.9 0.9 0.9"
        rotation="0 20 0"
        animation__float="property: object3D.position.y; to: 1; dir: alternate; dur: 5000; loop: true"
        class="interactive"
      ></a-gltf-model>

      <a-gltf-model
        id="guitarModel"
        src="#guitar"
        position="0 0 -10"
        scale="0.7 0.7 0.7"
        rotation="0 0 0"
        animation__float="property: object3D.position.y; to: 0.4; dir: alternate; dur: 2000; loop: true"
        class="interactive"
      ></a-gltf-model>

      <a-light type="ambient" color="#FFF"></a-light>
      <a-camera position="0 1.6 0" cursor="fuse: false; rayOrigin: mouse"></a-camera>

      <script>
        let audioContext;
        let buffers = {};
        let sounds = {
          drums: document.querySelector('#sound-drums'),
          guitar: document.querySelector('#sound-guitar'),
          piano: document.querySelector('#sound-piano')
        };

        // Funktion zum Laden der Audio-Dateien
        function loadAudioFiles() {
          const audioKeys = Object.keys(sounds);
          audioKeys.forEach(key => {
            const audio = sounds[key];
            const request = new XMLHttpRequest();
            request.open('GET', audio.src, true);
            request.responseType = 'arraybuffer';
            request.onload = function() {
              audioContext.decodeAudioData(request.response, function(buffer) {
                buffers[key] = buffer; // Speichern des Audio-Puffers
              });
            };
            request.send();
          });
        }

        // Funktion zum Starten aller Sounds gleichzeitig
        function startAllSounds() {
          const startTime = audioContext.currentTime; // Gemeinsamer Startzeitpunkt

          Object.keys(buffers).forEach((key) => {
            const source = audioContext.createBufferSource();
            source.buffer = buffers[key];
            source.loop = true;

            // Verbinde mit dem Audio Context und dem Ziel (lautsprecher)
            source.connect(audioContext.destination);

            // Starten der Audioquelle exakt zur gleichen Zeit
            source.start(startTime);
          });
        }

        // Funktion zum Umkehren des muted-Status
        function toggleSound(modelId) {
          const sound = sounds[modelId.replace('Model', '')]; // Hole das Sound-Element
          if (sound) {
            sound.muted = !sound.muted; // Umkehren des muted-Status
          }
        }

        // Event Listener für das erste Klick-Event
        let hasStarted = false;
        document.querySelectorAll('.interactive').forEach((model) => {
          model.addEventListener('click', (e) => {
            if (!hasStarted) {
              // Initialisiere den AudioContext nach der ersten Interaktion
              audioContext = new (window.AudioContext || window.webkitAudioContext)();
              loadAudioFiles(); // Lade die Audiodateien
              startAllSounds(); // Alle Sounds starten
              hasStarted = true; // Verhindern, dass die Sounds mehrfach gestartet werden
            }
            const modelId = e.target.id; // Hole die ID des geklickten Modells
            toggleSound(modelId); // Schalte den Sound stumm oder wieder hörbar
          });
        });
      </script>
    </a-scene>
  </body>
</html>
