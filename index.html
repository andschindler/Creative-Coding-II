<!DOCTYPE html>
<html lang="en">
  <head>
    <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-environment-component@1.3.x/dist/aframe-environment-component.min.js"></script>
  </head>

  <body>
    <a-scene>
      <a-assets>
        <img id="skyTexture"
      src="https://cdn.glitch.global/deaad1b3-c137-49a3-b9f1-f506e217d6d8/AdobeStock_1038456312.jpeg?v=1750797579902">
        <a-asset-item
          id="mic"
          src="https://cdn.glitch.global/deaad1b3-c137-49a3-b9f1-f506e217d6d8/vintage_microphone.glb?v=1750781974892"
        ></a-asset-item>
        <a-asset-item
          id="guitar"
          src="https://cdn.glitch.global/dac312c4-5145-47d4-8a18-3684e2763a69/generic_electronic_guitar.glb?v=1750723479382"
        ></a-asset-item>
        <a-asset-item
          id="drums"
          src="https://cdn.glitch.global/dac312c4-5145-47d4-8a18-3684e2763a69/drums.glb?v=1750725752915"
        ></a-asset-item>

        <!-- Audio-Ressourcen -->
        <audio id="sound-drums" src="https://cdn.glitch.global/deaad1b3-c137-49a3-b9f1-f506e217d6d8/Michael%20Jackson%20Loop-drums.mp3?v=1750764225146" loop="true"></audio>
        <audio id="sound-guitar" src="https://cdn.glitch.global/deaad1b3-c137-49a3-b9f1-f506e217d6d8/Michael%20Jackson%20Loop-bass.mp3?v=1750764228420" loop="true"></audio>
        <audio id="sound-mic" src="https://cdn.glitch.global/deaad1b3-c137-49a3-b9f1-f506e217d6d8/Michael%20Jackson%20Loop-vocals.mp3?v=1750764233292" loop="true"></audio>
      </a-assets>

      <a-gltf-model
        id="micModel"
        src="#mic"
        position="2 1 -2"
        scale="0.3 0.3 0.3"
        rotation="0 10 10"
        animation__float="property: object3D.position.y; to: 1.2; dir: alternate; dur: 2000; loop: true"
        class="interactive"
      ></a-gltf-model>

      <a-gltf-model
        id="drumsModel"
        src="#drums"
        position="-2 1.2 -2"
        scale="0.9 0.9 0.9"
        rotation="0 20 0"
        animation__float="property: object3D.position.y; to: 1; dir: alternate; dur: 5000; loop: true"
        class="interactive"
      ></a-gltf-model>

      <a-gltf-model
        id="guitarModel"
        src="#guitar"
        position="0 1.5 -1"
        scale="0.1 0.1 0.1"
        rotation="0 0 0"
        animation__float="property: object3D.position.y; to: 1.4; dir: alternate; dur: 2000; loop: true"
        class="interactive"
      ></a-gltf-model>

      <a-light type="ambient" color="#FFF"></a-light>
      <a-camera position="0 1.6 0" cursor="fuse: false; rayOrigin: mouse"></a-camera>
  <a-sky src="#skyTexture" rotation="90 90 90"></a-sky>

      <script>
        // Erstelle die Audioquellen für die Sounds
        const sounds = {
          drums: document.querySelector('#sound-drums'),
          guitar: document.querySelector('#sound-guitar'),
          mic: document.querySelector('#sound-mic'),
        };

        // Funktion zum Starten oder Stummschalten eines Sounds
        function toggleSound(modelId) {
          const sound = sounds[modelId.replace('Model', '')]; // Hole das entsprechende Audioelement
          if (sound) {
            sound.muted = !sound.muted; // Wechsle zwischen stumm und hörbar
          }
        }

        // Funktion zum gleichzeitigen Starten aller Sounds
        function startAllSounds(modelId) {
          Object.keys(sounds).forEach((key) => {
            const sound = sounds[key];
            sound.play(); // Starte alle Sounds synchron
            sound.muted = true; // Mute alle sounds

            const toggledSound = sounds[modelId.replace('Model', '')]; //angewähltes Modell
            toggledSound.muted = !toggleSound.muted; //entmute nur angewähltes Modell
          });
        }

        // Füge EventListener für Klicks auf interaktive Modelle hinzu
        let hasStarted = false;
        document.querySelectorAll('.interactive').forEach((model) => {
          model.addEventListener('click', (e) => {
            const modelId = e.target.id; // Hole die ID des geklickten Modells
            if (!hasStarted) {
              startAllSounds(modelId); // Starte alle Sounds bei der ersten Interaktion
              hasStarted = true; // Verhindere mehrfaches Starten
              sendStartAllSounds(modelId); // Informiere andere Clients
            }
            toggleSound(modelId); // Stummschalten oder aktivieren
            sendSoundToggle(modelId); // Informiere andere Clients
          });
        });

        // Kommunikation mit Web-Rooms
        // Adresse des Web-Rooms WebSocket-Servers
        const webRoomsWebSocketServerAddr = 'https://nosch.uber.space/web-rooms/';
        // Variablen
        let clientId = null; // Client-ID, vom Server beim Betreten des Raumes gesendet
        let clientCount = 0; // Anzahl der verbundenen Clients im Raum

        const socket = new WebSocket(webRoomsWebSocketServerAddr);

        // Sende Nachricht "start-sound" an alle anderen Clients
        function sendStartAllSounds(modelId) {
          sendRequest('*broadcast-message*', ['start-sound', modelId]);
        }
        // Sende Nachricht "sound-toggle" an alle anderen Clients
        function sendSoundToggle(modelId) {
          sendRequest('*broadcast-message*', ['sound-toggle', modelId]);
        }

        // Hilfsfunktion zum Senden von Nachrichten über WebSocket an den Server
        function sendRequest(...message) {
          const str = JSON.stringify(message);
          socket.send(str);
        }

        // Ereignis bei Verbindungsaufbau mit dem Server
        socket.addEventListener('open', (event) => {
          sendRequest('*enter-room*', 'hello-world');
          sendRequest('*subscribe-client-count*');
          sendRequest('*subscribe-client-enter-exit*');
          // Sende regelmäßig eine leere Nachricht, um Verbindung aufrechtzuerhalten
          setInterval(() => socket.send(''), 30000);
        });

        socket.addEventListener("close", (event) => {
          clientId = null;
          document.body.classList.add('disconnected');
        });

        // Nachrichten vom Server empfangen
        socket.addEventListener('message', (event) => {
          const data = event.data;
          if (data.length > 0) {
            const incoming = JSON.parse(data);
            const selector = incoming[0];

            // Behandle eingehende Nachrichten
            switch (selector) {
            // Antwort auf '*enter-room*'
            case '*client-id*':
              clientId = incoming[1];
              break;

            // Antwort auf '*subscribe-client-count*'
            case '*client-count*':
              clientCount = incoming[1];
              break;

            case '*client-enter*':
              const enterId = incoming[1];
              console.log(`Client #${enterId} hat den Raum betreten`);
              break;
            case '*client-exit*':
              const exitId = incoming[1];
              console.log(`Client #${exitId} hat den Raum verlassen`);
              break;

            case 'start-sound': {
              const modelId = incoming[1];
              console.log(modelId);
              startAllSounds(modelId); // Starte Sounds bei anderen Clients
              break;
            }
            
            case 'sound-toggle': {
              const modelId = incoming[1]; // { action: 'toggle', modelId: '...' }
              console.log(modelId);
              // Schalte den Sound für das angegebene Modell um
              toggleSound(modelId);
              break;
            }

            case '*error*': {
              const message = incoming[1];
              console.warn('Serverfehler:', ...message);
              break;
            }

            default:
              console.log(`Unbekannte eingehende Nachricht: [${incoming}]`);
              break;
            }
          }
        });
      </script>
    </a-scene>
  </body>
</html>
